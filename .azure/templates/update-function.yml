parameters:
  - name: appName
    type: string
  - name: parametersFileName
    type: string
  - name: workingDir
    type: string
    default: "$(Pipeline.Workspace)/github"

steps:
  - task: FuncToolsInstaller@0
    displayName: Install the latest Azure Function Tools
    inputs:
      version: "latest"

  - task: ArchiveFiles@2
    displayName: "Archive files"
    inputs:
      rootFolderOrFile: ${{ parameters.workingDir }}
      includeRootFolder: false
      archiveFile: "$(System.DefaultWorkingDirectory)/build/$(Build.BuildId).zip"

  - task: AzureCLI@2
    displayName: Read variables from ${{ parameters.parametersFileName }}
    inputs:
      azureSubscription: $(azureServiceConnection)
      scriptType: pscore
      scriptLocation: inlineScript
      inlineScript: |
        $envStr = ""
        $variables = Get-Content /home/vsts/work/1/github/.azure/${{ parameters.parametersFileName }} | ConvertFrom-Json -AsHashtable
        $appName = "${{ parameters.appName }}"
        $envVariables = $variables.parameters.environmentVariables.value
        $secretNames = $variables.parameters.secretNames.value

        $keyVaultName = (az webapp config appsettings list --name $appName -g $appName -o json | convertfrom-json | Where-Object{$_.value -match "@Microsoft"})

        if ($keyVaultName.length -gt 0) {
            $keyVaultName = $keyVaultName[0].value -split "VaultName="
            if ($keyVaultName.length -gt 0) {
                $keyVaultName = ($keyVaultName[1] -split ";")[0]
            }
        }
        if ($keyVaultName.length -eq 0) {
          $keyVaultName = $appName -replace("-", "")
        }

        foreach ($env in $envVariables.getenumerator()) { 
          $value = $env.value
          try {
            $value = $env.value.replace('"','\"')
          } catch {}
          $envStr += '"{0}={1}" ' -f $env.name,$value
        }

        foreach ($secretName in $secretNames) {
          $value = "@Microsoft.KeyVault(VaultName=$($keyVaultName);SecretName=$($secretName -replace '_', '-'))"
          $envStr += '"{0}={1}" ' -f $secretName,$value
        }

        Write-Host "##vso[task.setvariable variable=envStr]$envStr"
  - script: echo $funcEnv
    env:
      funcEnv: $(envStr)

  - task: AzureCLI@2
    timeoutInMinutes: 15
    displayName: Update function
    # condition: and(succeeded(), eq('${{ parameters.hasSlot }}', 'true'))
    inputs:
      azureSubscription: $(azureServiceConnection)
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az functionapp config appsettings set --name ${{ parameters.appName }} --resource-group ${{ parameters.appName }} --settings $(envStr) 
        az functionapp deployment source config-zip --name ${{ parameters.appName }} --resource-group ${{ parameters.appName }} --src '$(System.DefaultWorkingDirectory)/build/$(Build.BuildId).zip'
